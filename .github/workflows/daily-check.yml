name: Daily Product Expiry Check

on:
  schedule:
    # Executa √†s 21:00 hor√°rio de Bras√≠lia (00:00 UTC do dia seguinte)
    - cron: '0 0 * * *'
  workflow_dispatch: # Permite execu√ß√£o manual no GitHub

jobs:
  check-expiry:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Call API to check product expiry
        run: |
          echo "üöÄ Iniciando verifica√ß√£o de validade..."
          echo "‚è∞ Hor√°rio UTC: $(date -u)"
          echo "üáßüá∑ Hor√°rio Bras√≠lia: $(TZ='America/Sao_Paulo' date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            ${{ secrets.API_URL }}/api/check-expiry)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Status HTTP: $http_code"
          echo "üìù Resposta: $body"
          
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ Verifica√ß√£o executada com sucesso!"
          else
            echo "‚ùå Erro na execu√ß√£o!"
            exit 1
          fi
        
      - name: Notify on failure
        if: failure()
        run: |
          echo "üö® FALHA na verifica√ß√£o de validade!"
          echo "Verifique os logs acima para mais detalhes."